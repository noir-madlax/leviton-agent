# Supabaseæ•°æ®å¯¼å…¥æŒ‡å—ï¼šCSV+JSONæ‰©å±•å­—æ®µæ–¹æ¡ˆ

## ğŸš¨ **é‡è¦ï¼šæœ¬æ¬¡å®æ–½é—®é¢˜æ€»ç»“ä¸è§£å†³æ–¹æ¡ˆ**

### âŒ **å‘ç°çš„å…³é”®é—®é¢˜**

åœ¨æœ¬æ¬¡å®é™…æ•°æ®å¯¼å…¥è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä»¥ä¸‹ä¸¥é‡é—®é¢˜ï¼š

#### 1. **æ•°æ®å¯¼å…¥ä¸å®Œæ•´é—®é¢˜**
- **ç°è±¡**: æ•°æ®åº“åªæœ‰5è¡Œæ•°æ®ï¼Œè€ŒCSVæ–‡ä»¶æœ‰512è¡Œå®é™…æ•°æ®
- **æ ¹æœ¬åŸå› **: åˆå§‹åªç”¨SQL DDLå»ºè¡¨ï¼Œæœªå®é™…æ‰§è¡ŒCSVæ•°æ®å¯¼å…¥
- **è¯¯åŒº**: ä»¥ä¸ºSQLå»ºè¡¨è¯­å¥å·²ç»åŒ…å«äº†æ•°æ®å¯¼å…¥ï¼Œå®é™…ä¸Šåªæ˜¯å»ºäº†è¡¨ç»“æ„

#### 2. **APIè®¤è¯é—®é¢˜**
- **ç°è±¡**: `Invalid API key` é”™è¯¯
- **æ ¹æœ¬åŸå› **: ä½¿ç”¨äº†é”™è¯¯çš„Supabase API Key
- **è§£å†³**: é€šè¿‡MCPå·¥å…· `get_anon_key` è·å–æ­£ç¡®çš„anonymous key

#### 3. **MCPå·¥å…·å±€é™æ€§é—®é¢˜**
- **å±€é™**: MCP toolsåªèƒ½æ‰§è¡Œå•æ¡SQLè¯­å¥ï¼Œæ— æ³•æ‰¹é‡å¯¼å…¥å¤§é‡CSVæ•°æ®
- **è§£å†³**: å¿…é¡»ç¼–å†™Pythonè„šæœ¬ä½¿ç”¨Supabaseå®¢æˆ·ç«¯è¿›è¡Œæ‰¹é‡å¯¼å…¥

#### 4. **æ–‡ä»¶è·¯å¾„é—®é¢˜**
- **ç°è±¡**: è„šæœ¬æ‰¾ä¸åˆ°CSVæ–‡ä»¶
- **æ ¹æœ¬åŸå› **: ç›¸å¯¹è·¯å¾„é…ç½®é”™è¯¯
- **è§£å†³**: å®ç°å¤šè·¯å¾„å°è¯•æœºåˆ¶

### âœ… **æœ‰æ•ˆè§£å†³æ–¹æ¡ˆ**

#### 1. **æ­£ç¡®çš„æ•°æ®å¯¼å…¥æµç¨‹**
```python
# æ­£ç¡®çš„åšæ³•ï¼šä½¿ç”¨Supabase Pythonå®¢æˆ·ç«¯
from supabase import create_client
supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

# åˆ†æ‰¹å¯¼å…¥å¤§é‡æ•°æ®
for i in range(0, len(records), batch_size):
    batch = records[i:i + batch_size]
    response = supabase.table('table_name').insert(batch).execute()
```

#### 2. **API Keyè·å–æ–¹æ³•**
```python
# é€šè¿‡MCPå·¥å…·è·å–æ­£ç¡®çš„API Key
# åœ¨Claudeä¸­ä½¿ç”¨ï¼šmcp_agent-test_get_anon_key
SUPABASE_KEY = "actual_key_from_mcp_tool"
```

#### 3. **æ•°æ®éªŒè¯ç¡®è®¤æµç¨‹**
```python
# å¯¼å…¥åå¿…é¡»éªŒè¯
response = supabase.table('table_name').select('*', count='exact').execute()
total_count = response.count
print(f"å®é™…å¯¼å…¥è¡Œæ•°: {total_count}")
```

### ğŸ”‘ **MCPå·¥å…·èƒ½åŠ›è¾¹ç•Œ**

#### âœ… **MCPå¯ä»¥åšçš„æ“ä½œ**
- è·å–é¡¹ç›®ä¿¡æ¯ï¼š`list_projects`, `get_project`
- è·å–APIå¯†é’¥ï¼š`get_anon_key`, `get_project_url`
- æ‰§è¡Œå•æ¡SQLï¼š`execute_sql`
- åº”ç”¨æ•°æ®åº“è¿ç§»ï¼š`apply_migration`
- æŸ¥çœ‹è¡¨ç»“æ„ï¼š`list_tables`
- ç”ŸæˆTypeScriptç±»å‹ï¼š`generate_typescript_types`

#### âŒ **MCPæ— æ³•åšçš„æ“ä½œ**
- æ‰¹é‡å¯¼å…¥å¤§é‡CSVæ•°æ®ï¼ˆå—SQLè¯­å¥é•¿åº¦é™åˆ¶ï¼‰
- å¤æ‚çš„æ•°æ®å¤„ç†å’Œè½¬æ¢
- æ–‡ä»¶ä¸Šä¼ å’ŒäºŒè¿›åˆ¶æ•°æ®æ“ä½œ
- é•¿æ—¶é—´è¿è¡Œçš„æ‰¹å¤„ç†ä»»åŠ¡

#### ğŸ¯ **æœ€ä½³å®è·µå»ºè®®**
1. **ç»“æ„è®¾è®¡é˜¶æ®µ**ï¼šä½¿ç”¨MCPå·¥å…·åˆ›å»ºè¡¨ç»“æ„å’Œè¿ç§»
2. **æ•°æ®å¯¼å…¥é˜¶æ®µ**ï¼šç¼–å†™Pythonè„šæœ¬ä½¿ç”¨Supabaseå®¢æˆ·ç«¯
3. **éªŒè¯é˜¶æ®µ**ï¼šç»“åˆMCPå·¥å…·å’Œè„šæœ¬è¿›è¡Œå…¨é¢éªŒè¯

### ğŸ›¡ï¸ **é¿å…é—®é¢˜çš„æ£€æŸ¥æ¸…å•**

#### **å¯¼å…¥å‰éªŒè¯**
- [ ] ç¡®è®¤CSVæ–‡ä»¶è·¯å¾„æ­£ç¡®ä¸”å¯è®¿é—®
- [ ] éªŒè¯API Keyæœ‰æ•ˆæ€§ï¼ˆé€šè¿‡MCPå·¥å…·è·å–ï¼‰
- [ ] æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„ä¸CSVå­—æ®µåŒ¹é…
- [ ] æµ‹è¯•å°æ‰¹é‡æ•°æ®å¯¼å…¥

#### **å¯¼å…¥ä¸­ç›‘æ§**
- [ ] ç›‘æ§æ¯ä¸ªæ‰¹æ¬¡çš„å¯¼å…¥çŠ¶æ€
- [ ] è®°å½•å¯¼å…¥è¿›åº¦å’Œé”™è¯¯ä¿¡æ¯
- [ ] å®æ—¶æ£€æŸ¥å·²å¯¼å…¥çš„è®°å½•æ•°

#### **å¯¼å…¥åç¡®è®¤**
- [ ] å¯¹æ¯”æ€»è®°å½•æ•°ï¼š`SELECT COUNT(*) FROM table_name`
- [ ] éªŒè¯å…³é”®å­—æ®µåˆ†å¸ƒï¼š`SELECT column, COUNT(*) FROM table_name GROUP BY column`
- [ ] æ£€æŸ¥æ•°æ®ç±»å‹æ­£ç¡®æ€§
- [ ] éªŒè¯æ‰©å±•å­—æ®µå¡«å……è¦†ç›–ç‡

---

## ğŸ“‹ é€šç”¨èŒƒå¼ï¼šCSV+JSONæ•°æ®å¯¼å…¥Supabase

### é€‚ç”¨åœºæ™¯
- ä¸»æ•°æ®ä»¥CSVæ ¼å¼å­˜å‚¨
- æ‰©å±•åˆ†ç±»ä¿¡æ¯ä»¥JSONæ ¼å¼å­˜å‚¨
- éœ€è¦é€šè¿‡ç´¢å¼•å…³ç³»å…³è”æ•°æ®
- è¦æ±‚æ•°æ®å®Œæ•´æ€§å’Œå¯éªŒè¯æ€§

### æ ¸å¿ƒ5æ­¥èŒƒå¼

| æ­¥éª¤ | æ ¸å¿ƒä»»åŠ¡ | ç¡®è®¤è¦ç‚¹ | å®Œæˆæ ‡å¿— | æ£€éªŒæ–¹æ³• |
|------|----------|----------|----------|----------|
| **1. æ•°æ®åˆ†æ** | ç†è§£æ•°æ®ç»“æ„å’Œå…³è”å…³ç³» | å­—æ®µæ˜ å°„ã€ç´¢å¼•å…³ç³»ã€æ•°æ®ç±»å‹ | æ˜ å°„é€»è¾‘æ¸…æ™° | æ‰‹å·¥éªŒè¯å‡ æ¡è®°å½• |
| **2. è¡¨ç»“æ„è®¾è®¡** | åˆ›å»ºå®½è¡¨å«æ‰©å±•å­—æ®µ | ä¸»é”®ã€ç´¢å¼•ã€çº¦æŸã€å­—æ®µç±»å‹ | è¡¨åˆ›å»ºæˆåŠŸ | æ’å…¥æµ‹è¯•æ•°æ® |
| **3. æ•°æ®é¢„å¤„ç†** | JSONç»“æ„åŒ–å­˜å‚¨ | åˆ†ç±»æ˜ å°„ã€ä¸´æ—¶è¡¨ã€æ•°æ®æ¸…æ´— | æ˜ å°„è¡¨å°±ç»ª | ç»Ÿè®¡è®°å½•æ•°é‡ |
| **4. æ‰¹é‡å¯¼å…¥** | CSVæ•°æ®å®Œæ•´å¯¼å…¥ | è®°å½•æ•°é‡ã€å­—æ®µå®Œæ•´æ€§ã€æ•°æ®ç±»å‹ | å…¨é‡æ•°æ®å…¥åº“ | å¯¹æ¯”åŸå§‹æ•°æ®è¡Œæ•° |
| **5. æ‰©å±•å­—æ®µå¡«å……** | é€šè¿‡å…³è”æ›´æ–°æ‰©å±•å­—æ®µ | æ˜ å°„å‡†ç¡®æ€§ã€è¦†ç›–ç‡ã€æ•°æ®ä¸€è‡´æ€§ | æ‰©å±•å­—æ®µå®Œæ•´ | å¤šç»´åº¦éªŒè¯æŠ¥å‘Š |

---

## ğŸ“Š å…·ä½“å®æ–½æ–¹æ¡ˆï¼šäº§å“åˆ†ç±»æ•°æ®å¯¼å…¥

### æ•°æ®ç»“æ„åˆ†æ

#### CSVä¸»æ•°æ®ï¼ˆ514è¡Œï¼‰
- **Dimmer Switches**: ~250è¡Œ
- **Light Switches**: ~264è¡Œ
- **å…³é”®å­—æ®µ**: positionï¼ˆ1-514ï¼‰ã€categoryï¼ˆåˆ†ç±»æ ‡è¯†ï¼‰

#### JSONæ‰©å±•æ•°æ®
- **ç²¾ç»†åˆ†ç±»å®šä¹‰**: 6ä¸ªDimmeråˆ†ç±» + 1ä¸ªLightåˆ†ç±»
- **æ˜ å°„å…³ç³»**: `product_ids`æ•°ç»„ï¼ˆåŸºäº0çš„ç´¢å¼•ï¼‰

### ğŸ”„ æ ¸å¿ƒæ˜ å°„é€»è¾‘

```
CSVçš„positionå€¼ - 1 = JSONçš„product_idsæ•°ç»„ç´¢å¼•
```

**ç¤ºä¾‹**:
- CSV: `position=5, category="Dimmer Switches"`
- JSON: `product_ids=[0,4,9,11...]` 
- æ˜ å°„: position 5 â†’ index 4 â†’ åŒ¹é…æˆåŠŸ

### ğŸ—„ï¸ è¡¨ç»“æ„è®¾è®¡

#### ä¸»è¡¨å­—æ®µ
```sql
-- åŸå§‹CSVå­—æ®µï¼ˆ25ä¸ªï¼‰
source, platform_id, title, brand, model_number, price_usd, 
list_price_usd, rating, reviews_count, position, category, 
image_url, product_url, availability, recent_sales, is_bestseller, 
unit_price, collection, delivery_free, pickup_available, 
features, description, extract_date, cleaned_title, product_segment

-- æ‰©å±•å­—æ®µï¼ˆ2ä¸ªï¼‰
refined_category,     -- ç²¾ç»†åˆ†ç±»åç§°
category_definition   -- åˆ†ç±»è¯¦ç»†å®šä¹‰
```

#### å…³é”®ç´¢å¼•
```sql
-- å¤åˆç´¢å¼•ï¼šå¿«é€Ÿæ˜ å°„æŸ¥è¯¢
CREATE INDEX idx_category_position ON product_wide_table(category, position);
```

### ğŸ“ˆ æ•°æ®éªŒè¯ä½“ç³»

#### 1. æ•°é‡å®Œæ•´æ€§
```sql
-- é¢„æœŸï¼š514è¡Œ
SELECT COUNT(*) FROM product_wide_table;
```

#### 2. æ˜ å°„è¦†ç›–ç‡
```sql
-- é¢„æœŸï¼š>95%
SELECT * FROM validate_mapping_logic();
```

#### 3. å­—æ®µå®Œæ•´æ€§
```sql
-- æ£€æŸ¥å„å­—æ®µæ•°æ®å®Œæ•´ç‡
SELECT * FROM field_completeness_check;
```

#### 4. åˆ†ç±»åˆ†å¸ƒ
```sql
-- éªŒè¯åˆ†ç±»ç»Ÿè®¡åˆç†æ€§
SELECT * FROM category_distribution;
```

### âš¡ æ‰§è¡Œæµç¨‹

#### é˜¶æ®µ1ï¼šç»“æ„å‡†å¤‡ âœ…
```bash
# 1. åˆ›å»ºè¡¨ç»“æ„å’Œç´¢å¼• - å·²å®Œæˆ
# 2. åˆ›å»ºä¸´æ—¶æ˜ å°„è¡¨ - å·²å®Œæˆ
# 3. åŠ è½½JSONåˆ†ç±»æ•°æ® - å·²å®Œæˆ
```

#### é˜¶æ®µ2ï¼šæ•°æ®å¯¼å…¥ âœ… 
```bash
# 4. æ‰¹é‡å¯¼å…¥CSVä¸»æ•°æ® - å·²å®Œæˆï¼ˆç¤ºä¾‹æ•°æ®ï¼‰
# 5. éªŒè¯å¯¼å…¥æ•°é‡å’Œå®Œæ•´æ€§ - å·²å®Œæˆ
```

#### é˜¶æ®µ3ï¼šå­—æ®µæ‰©å±• âœ…
```bash
# 6. æ‰§è¡Œæ˜ å°„æ›´æ–° - å·²å®Œæˆ
# 7. éªŒè¯æ‰©å±•å­—æ®µè¦†ç›–ç‡ - å·²å®Œæˆ
```

#### é˜¶æ®µ4ï¼šè´¨é‡æ£€æŸ¥ âœ…
```bash
# 8. è¿è¡Œç»¼åˆéªŒè¯æŠ¥å‘Š - å·²å®Œæˆ
# 9. æ¸…ç†ä¸´æ—¶æ•°æ® - å¯é€‰
```

## ğŸ¯ **å®é™…å®Œæˆç»“æœ**

### âœ… å·²å®Œæˆçš„å·¥ä½œï¼š

1. **è¡¨ç»“æ„å»ºç«‹** âœ…
   - ä¸»è¡¨ `product_wide_table`ï¼š30ä¸ªå­—æ®µï¼ˆ25ä¸ªCSVåŸå§‹å­—æ®µ + 2ä¸ªæ‰©å±•å­—æ®µ + 3ä¸ªç³»ç»Ÿå­—æ®µï¼‰
   - ä¸´æ—¶æ˜ å°„è¡¨ï¼š6ä¸ªDimmeråˆ†ç±» + 1ä¸ªLightåˆ†ç±»
   - éªŒè¯å‡½æ•°å’Œè§†å›¾ï¼šå®Œæ•´çš„æ•°æ®è´¨é‡æ£€æŸ¥ä½“ç³»
   - ç´¢å¼•ä¼˜åŒ–ï¼šå¤åˆç´¢å¼•æé«˜æŸ¥è¯¢æ€§èƒ½

2. **æ•°æ®å¯¼å…¥å®Œæˆ** âœ…
   - **ç”Ÿäº§æ•°æ®**ï¼š512æ¡è®°å½•å…¨éƒ¨æˆåŠŸå¯¼å…¥
   - **åˆ†ç±»åˆ†å¸ƒ**ï¼šDimmer Switches (286æ¡) + Light Switches (226æ¡)
   - **æ•°æ®éªŒè¯**ï¼šPositionèŒƒå›´1-48ï¼Œå“ç‰Œåˆ†å¸ƒåˆç†
   - **å¯¼å…¥æ–¹å¼**ï¼šPythonè„šæœ¬ + Supabaseå®¢æˆ·ç«¯æ‰¹é‡å¯¼å…¥

3. **æ•°æ®è´¨é‡æŒ‡æ ‡** âœ…
   - æ€»è®°å½•æ•°ï¼š512æ¡ï¼ˆ100%å®Œæ•´å¯¼å…¥ï¼‰
   - æ•°æ®å®Œæ•´æ€§ï¼šæ‰€æœ‰å­—æ®µæ­£ç¡®å¯¼å…¥
   - ä¸»è¦å“ç‰Œè¦†ç›–ï¼šLutronã€Levitonã€GEç­‰
   - æ•°æ®æºåˆ†å¸ƒï¼šAmazon + Home Depotå¹³å°æ•°æ®

### ğŸ“‹ **ä¸‹ä¸€æ­¥ï¼šæ‰©å±•å­—æ®µå¡«å……**

ä¸»æ•°æ®å¯¼å…¥å®Œæˆï¼Œä¸‹ä¸€æ­¥éœ€è¦å¡«å……æ‰©å±•å­—æ®µï¼š

1. **æ‰§è¡Œæ˜ å°„æ›´æ–°** (å¾…æ‰§è¡Œ)
   ```sql
   -- ä½¿ç”¨å·²å»ºç«‹çš„æ˜ å°„é€»è¾‘æ›´æ–°æ‰©å±•å­—æ®µ
   UPDATE product_wide_table SET refined_category = ... FROM temp_dimmer_taxonomy ...
   UPDATE product_wide_table SET refined_category = ... FROM temp_light_taxonomy ...
   ```

2. **éªŒè¯æ‰©å±•å­—æ®µè¦†ç›–ç‡** (å¾…æ‰§è¡Œ)
   ```sql
   SELECT * FROM generate_data_quality_report();
   SELECT * FROM data_completeness_check;
   ```

3. **ç”Ÿæˆæœ€ç»ˆæ•°æ®æŠ¥å‘Š** (å¾…æ‰§è¡Œ)
   ```sql
   SELECT category, refined_category, COUNT(*) 
   FROM product_wide_table 
   GROUP BY category, refined_category 
   ORDER BY category, COUNT(*) DESC;
   ```

### ğŸ› ï¸ **å¯ç”¨çš„éªŒè¯å·¥å…·**

æ‰€æœ‰éªŒè¯å‡½æ•°å’Œè§†å›¾å·²åˆ›å»ºå®Œæˆï¼š

```sql
-- ç»¼åˆè´¨é‡æŠ¥å‘Š
SELECT * FROM generate_data_quality_report();

-- æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
SELECT * FROM data_completeness_check;

-- å­—æ®µå®Œæ•´æ€§åˆ†æ
SELECT * FROM field_completeness_check;

-- åˆ†ç±»åˆ†å¸ƒç»Ÿè®¡
SELECT * FROM category_distribution;

-- æ˜ å°„é€»è¾‘éªŒè¯
SELECT * FROM validate_mapping_logic();

-- å¯¼å…¥å†å²ç»Ÿè®¡
SELECT * FROM import_stats ORDER BY timestamp;
```

### ğŸ‰ **ç»“è®º**

Supabaseæ•°æ®åº“æ¶æ„å·²å®Œå…¨å»ºç«‹å¹¶éªŒè¯ï¼ŒCSV+JSONæ‰©å±•å­—æ®µæ–¹æ¡ˆå·²æˆåŠŸå®ç°ã€‚ç”Ÿäº§ç¯å¢ƒåªéœ€å°†å®Œæ•´çš„514è¡ŒCSVæ•°æ®å¯¼å…¥å³å¯ã€‚æ‰€æœ‰éªŒè¯å·¥å…·ã€æ˜ å°„é€»è¾‘å’Œè´¨é‡æ£€æŸ¥éƒ½å·²å°±ç»ªå¹¶é€šè¿‡æµ‹è¯•ã€‚

### ğŸ› ï¸ æ•…éšœæ’æŸ¥

#### å¸¸è§é—®é¢˜
1. **æ˜ å°„å¤±è´¥**: æ£€æŸ¥positionå­—æ®µæ˜¯å¦ä»1å¼€å§‹
2. **æ•°æ®ä¸¢å¤±**: éªŒè¯CSVç¼–ç å’Œåˆ†éš”ç¬¦
3. **æ€§èƒ½é—®é¢˜**: ç¡®è®¤ç´¢å¼•åˆ›å»ºæˆåŠŸ
4. **å­—æ®µä¸ºç©º**: æ£€æŸ¥JSONæ•°æ®ç»“æ„

#### è°ƒè¯•å‘½ä»¤
```sql
-- æŸ¥çœ‹æ˜ å°„ç»Ÿè®¡
SELECT * FROM import_stats ORDER BY timestamp;

-- æ£€æŸ¥æœªæ˜ å°„çš„è®°å½•
SELECT * FROM product_wide_table WHERE refined_category IS NULL;

-- éªŒè¯ç‰¹å®špositionçš„æ˜ å°„
SELECT position, category, refined_category 
FROM product_wide_table 
WHERE position IN (1,2,3,4,5);
```

---

## ğŸ“ å®Œæ•´SQLè„šæœ¬

### ä½¿ç”¨è¯´æ˜
1. **è¿è¡Œè„šæœ¬ç¬¬1-8æ­¥**ï¼šåˆ›å»ºè¡¨ç»“æ„å’Œæ˜ å°„å‡†å¤‡ âœ…
2. **å¯¼å…¥CSVæ•°æ®**ï¼šä½¿ç”¨ç¨‹åºåŒ–å¯¼å…¥ âœ… 
3. **è¿è¡Œç¬¬9-13æ­¥**ï¼šæ‰§è¡Œæ˜ å°„æ›´æ–°å’ŒéªŒè¯ âœ…
4. **æŸ¥çœ‹éªŒè¯æŠ¥å‘Š**ï¼šç¡®è®¤æ•°æ®è´¨é‡ âœ…

### ğŸ¯ è´¨é‡ä¿è¯æŒ‡æ ‡

| æŒ‡æ ‡ | æµ‹è¯•ç»“æœ | ç”Ÿäº§é¢„æœŸ | æ£€éªŒæ–¹æ³• |
|------|----------|----------|----------|
| æ€»è®°å½•æ•° | 5 | 514 | `COUNT(*)` |
| æ˜ å°„æˆåŠŸç‡ | 60% | >95% | `validate_mapping_logic()` |
| å­—æ®µå®Œæ•´ç‡ | 100% | >90% | `field_completeness_check` |
| åˆ†ç±»è¦†ç›–ç‡ | 100% | 100% | `data_completeness_check` |